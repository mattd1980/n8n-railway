{"version":3,"sources":["../../../nodes/Google/GenericFunctions.ts"],"sourcesContent":["import * as jwt from 'jsonwebtoken';\nimport { DateTime } from 'luxon';\nimport moment from 'moment-timezone';\nimport {\n\ttype IExecuteFunctions,\n\ttype ILoadOptionsFunctions,\n\ttype ICredentialTestFunctions,\n\ttype IDataObject,\n\ttype IPollFunctions,\n\ttype IRequestOptions,\n\tNodeOperationError,\n} from 'n8n-workflow';\n\nimport { formatPrivateKey } from '@utils/utilities';\n\nconst googleServiceAccountScopes = {\n\tbigquery: ['https://www.googleapis.com/auth/bigquery'],\n\tbooks: ['https://www.googleapis.com/auth/books'],\n\tchat: ['https://www.googleapis.com/auth/chat.bot'],\n\tdocs: [\n\t\t'https://www.googleapis.com/auth/documents',\n\t\t'https://www.googleapis.com/auth/drive',\n\t\t'https://www.googleapis.com/auth/drive.file',\n\t],\n\tdrive: [\n\t\t'https://www.googleapis.com/auth/drive',\n\t\t'https://www.googleapis.com/auth/drive.appdata',\n\t\t'https://www.googleapis.com/auth/drive.photos.readonly',\n\t],\n\tgmail: [\n\t\t'https://www.googleapis.com/auth/gmail.labels',\n\t\t'https://www.googleapis.com/auth/gmail.addons.current.action.compose',\n\t\t'https://www.googleapis.com/auth/gmail.addons.current.message.action',\n\t\t'https://mail.google.com/',\n\t\t'https://www.googleapis.com/auth/gmail.modify',\n\t\t'https://www.googleapis.com/auth/gmail.compose',\n\t],\n\tsheetV1: [\n\t\t'https://www.googleapis.com/auth/drive',\n\t\t'https://www.googleapis.com/auth/drive.file',\n\t\t'https://www.googleapis.com/auth/spreadsheets',\n\t],\n\tsheetV2: [\n\t\t'https://www.googleapis.com/auth/drive.file',\n\t\t'https://www.googleapis.com/auth/spreadsheets',\n\t\t'https://www.googleapis.com/auth/drive.metadata',\n\t],\n\tslides: [\n\t\t'https://www.googleapis.com/auth/drive.file',\n\t\t'https://www.googleapis.com/auth/presentations',\n\t],\n\ttranslate: [\n\t\t'https://www.googleapis.com/auth/cloud-translation',\n\t\t'https://www.googleapis.com/auth/cloud-platform',\n\t],\n\tfirestore: [\n\t\t'https://www.googleapis.com/auth/datastore',\n\t\t'https://www.googleapis.com/auth/firebase',\n\t],\n\tvertex: ['https://www.googleapis.com/auth/cloud-platform'],\n};\n\ntype GoogleServiceAccount = keyof typeof googleServiceAccountScopes;\n\nexport async function getGoogleAccessToken(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions | ICredentialTestFunctions | IPollFunctions,\n\tcredentials: IDataObject,\n\tservice: GoogleServiceAccount,\n): Promise<IDataObject> {\n\t//https://developers.google.com/identity/protocols/oauth2/service-account#httprest\n\n\tconst scopes = googleServiceAccountScopes[service];\n\n\tconst privateKey = formatPrivateKey(credentials.privateKey as string);\n\tcredentials.email = ((credentials.email as string) || '').trim();\n\n\tconst now = moment().unix();\n\n\tconst signature = jwt.sign(\n\t\t{\n\t\t\tiss: credentials.email,\n\t\t\tsub: credentials.delegatedEmail || credentials.email,\n\t\t\tscope: scopes.join(' '),\n\t\t\taud: 'https://oauth2.googleapis.com/token',\n\t\t\tiat: now,\n\t\t\texp: now + 3600,\n\t\t},\n\t\tprivateKey,\n\t\t{\n\t\t\talgorithm: 'RS256',\n\t\t\theader: {\n\t\t\t\tkid: privateKey,\n\t\t\t\ttyp: 'JWT',\n\t\t\t\talg: 'RS256',\n\t\t\t},\n\t\t},\n\t);\n\n\tconst options: IRequestOptions = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t},\n\t\tmethod: 'POST',\n\t\tform: {\n\t\t\tgrant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',\n\t\t\tassertion: signature,\n\t\t},\n\t\turi: 'https://oauth2.googleapis.com/token',\n\t\tjson: true,\n\t};\n\n\treturn await this.helpers.request(options);\n}\n\nexport function validateAndSetDate(\n\tfilter: IDataObject,\n\tkey: string,\n\ttimezone: string,\n\tcontext: IExecuteFunctions,\n) {\n\tconst date = DateTime.fromISO(filter[key] as string);\n\tif (date.isValid) {\n\t\tfilter[key] = date.setZone(timezone).toISO();\n\t} else {\n\t\tthrow new NodeOperationError(\n\t\t\tcontext.getNode(),\n\t\t\t`The value \"${filter[key] as string}\" is not a valid DateTime.`,\n\t\t);\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAAqB;AACrB,mBAAyB;AACzB,6BAAmB;AACnB,0BAQO;AAEP,uBAAiC;AAEjC,MAAM,6BAA6B;AAAA,EAClC,UAAU,CAAC,0CAA0C;AAAA,EACrD,OAAO,CAAC,uCAAuC;AAAA,EAC/C,MAAM,CAAC,0CAA0C;AAAA,EACjD,MAAM;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EACD;AAAA,EACA,OAAO;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,EACD;AAAA,EACA,OAAO;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACD;AAAA,EACA,SAAS;AAAA,IACR;AAAA,IACA;AAAA,IACA;AAAA,EACD;AAAA,EACA,SAAS;AAAA,IACR;AAAA,IACA;AAAA,IACA;AAAA,EACD;AAAA,EACA,QAAQ;AAAA,IACP;AAAA,IACA;AAAA,EACD;AAAA,EACA,WAAW;AAAA,IACV;AAAA,IACA;AAAA,EACD;AAAA,EACA,WAAW;AAAA,IACV;AAAA,IACA;AAAA,EACD;AAAA,EACA,QAAQ,CAAC,gDAAgD;AAC1D;AAIA,eAAsB,qBAErB,aACA,SACuB;AAGvB,QAAM,SAAS,2BAA2B,OAAO;AAEjD,QAAM,iBAAa,mCAAiB,YAAY,UAAoB;AACpE,cAAY,SAAU,YAAY,SAAoB,IAAI,KAAK;AAE/D,QAAM,UAAM,uBAAAA,SAAO,EAAE,KAAK;AAE1B,QAAM,YAAY,IAAI;AAAA,IACrB;AAAA,MACC,KAAK,YAAY;AAAA,MACjB,KAAK,YAAY,kBAAkB,YAAY;AAAA,MAC/C,OAAO,OAAO,KAAK,GAAG;AAAA,MACtB,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK,MAAM;AAAA,IACZ;AAAA,IACA;AAAA,IACA;AAAA,MACC,WAAW;AAAA,MACX,QAAQ;AAAA,QACP,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,MACN;AAAA,IACD;AAAA,EACD;AAEA,QAAM,UAA2B;AAAA,IAChC,SAAS;AAAA,MACR,gBAAgB;AAAA,IACjB;AAAA,IACA,QAAQ;AAAA,IACR,MAAM;AAAA,MACL,YAAY;AAAA,MACZ,WAAW;AAAA,IACZ;AAAA,IACA,KAAK;AAAA,IACL,MAAM;AAAA,EACP;AAEA,SAAO,MAAM,KAAK,QAAQ,QAAQ,OAAO;AAC1C;AAEO,SAAS,mBACf,QACA,KACA,UACA,SACC;AACD,QAAM,OAAO,sBAAS,QAAQ,OAAO,GAAG,CAAW;AACnD,MAAI,KAAK,SAAS;AACjB,WAAO,GAAG,IAAI,KAAK,QAAQ,QAAQ,EAAE,MAAM;AAAA,EAC5C,OAAO;AACN,UAAM,IAAI;AAAA,MACT,QAAQ,QAAQ;AAAA,MAChB,cAAc,OAAO,GAAG,CAAW;AAAA,IACpC;AAAA,EACD;AACD;","names":["moment"]}