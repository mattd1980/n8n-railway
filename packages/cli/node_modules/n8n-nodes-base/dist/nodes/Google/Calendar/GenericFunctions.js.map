{"version":3,"sources":["../../../../nodes/Google/Calendar/GenericFunctions.ts"],"sourcesContent":["import { DateTime } from 'luxon';\nimport moment from 'moment-timezone';\nimport type {\n\tIDataObject,\n\tIExecuteFunctions,\n\tIHttpRequestMethods,\n\tILoadOptionsFunctions,\n\tINode,\n\tINodeListSearchItems,\n\tINodeListSearchResult,\n\tIPollFunctions,\n\tIRequestOptions,\n\tJsonObject,\n} from 'n8n-workflow';\nimport { NodeApiError, NodeOperationError, sleep } from 'n8n-workflow';\nimport { RRule } from 'rrule';\n\nimport type { RecurringEventInstance } from './EventInterface';\n\nexport async function googleApiRequest(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions | IPollFunctions,\n\tmethod: IHttpRequestMethods,\n\tresource: string,\n\tbody: any = {},\n\tqs: IDataObject = {},\n\turi?: string,\n\theaders: IDataObject = {},\n): Promise<any> {\n\tconst options: IRequestOptions = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json',\n\t\t},\n\t\tmethod,\n\t\tbody,\n\t\tqs,\n\t\turi: uri || `https://www.googleapis.com${resource}`,\n\t\tjson: true,\n\t};\n\ttry {\n\t\tif (Object.keys(headers).length !== 0) {\n\t\t\toptions.headers = Object.assign({}, options.headers, headers);\n\t\t}\n\t\tif (Object.keys(body as IDataObject).length === 0) {\n\t\t\tdelete options.body;\n\t\t}\n\t\treturn await this.helpers.requestOAuth2.call(this, 'googleCalendarOAuth2Api', options);\n\t} catch (error) {\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n}\n\nexport async function googleApiRequestAllItems(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions | IPollFunctions,\n\tpropertyName: string,\n\tmethod: IHttpRequestMethods,\n\tendpoint: string,\n\tbody: any = {},\n\tquery: IDataObject = {},\n): Promise<any> {\n\tconst returnData: IDataObject[] = [];\n\n\tlet responseData;\n\tquery.maxResults = 100;\n\n\tdo {\n\t\tresponseData = await googleApiRequest.call(this, method, endpoint, body, query);\n\t\tquery.pageToken = responseData.nextPageToken;\n\t\treturnData.push.apply(returnData, responseData[propertyName] as IDataObject[]);\n\t} while (responseData.nextPageToken !== undefined && responseData.nextPageToken !== '');\n\n\treturn returnData;\n}\n\nexport function encodeURIComponentOnce(uri: string) {\n\t// load options used to save encoded uri strings\n\treturn encodeURIComponent(decodeURIComponent(uri));\n}\n\nexport async function getCalendars(\n\tthis: ILoadOptionsFunctions,\n\tfilter?: string,\n): Promise<INodeListSearchResult> {\n\tconst calendars = (await googleApiRequestAllItems.call(\n\t\tthis,\n\t\t'items',\n\t\t'GET',\n\t\t'/calendar/v3/users/me/calendarList',\n\t)) as Array<{ id: string; summary: string }>;\n\n\tconst results: INodeListSearchItems[] = calendars\n\t\t.map((c) => ({\n\t\t\tname: c.summary,\n\t\t\tvalue: c.id,\n\t\t}))\n\t\t.filter(\n\t\t\t(c) =>\n\t\t\t\t!filter ||\n\t\t\t\tc.name.toLowerCase().includes(filter.toLowerCase()) ||\n\t\t\t\tc.value?.toString() === filter,\n\t\t)\n\t\t.sort((a, b) => {\n\t\t\tif (a.name.toLowerCase() < b.name.toLowerCase()) return -1;\n\t\t\tif (a.name.toLowerCase() > b.name.toLowerCase()) return 1;\n\t\t\treturn 0;\n\t\t});\n\treturn { results };\n}\n\nexport const TIMEZONE_VALIDATION_REGEX = `(${moment.tz\n\t.names()\n\t.map((t) => t.replace('+', '\\\\+'))\n\t.join('|')})[ \\t]*`;\n\nexport async function getTimezones(\n\tthis: ILoadOptionsFunctions,\n\tfilter?: string,\n): Promise<INodeListSearchResult> {\n\tconst results: INodeListSearchItems[] = moment.tz\n\t\t.names()\n\t\t.map((timezone) => ({\n\t\t\tname: timezone,\n\t\t\tvalue: timezone,\n\t\t}))\n\t\t.filter(\n\t\t\t(c) =>\n\t\t\t\t!filter ||\n\t\t\t\tc.name.toLowerCase().includes(filter.toLowerCase()) ||\n\t\t\t\tc.value?.toString() === filter,\n\t\t);\n\treturn { results };\n}\n\nexport type RecurrentEvent = {\n\tstart: {\n\t\tdate?: string;\n\t\tdateTime?: string;\n\t\ttimeZone?: string;\n\t};\n\tend: {\n\t\tdate?: string;\n\t\tdateTime?: string;\n\t\ttimeZone?: string;\n\t};\n\trecurrence: string[];\n\tnextOccurrence?: {\n\t\tstart: {\n\t\t\tdateTime: string;\n\t\t\ttimeZone?: string;\n\t\t};\n\t\tend: {\n\t\t\tdateTime: string;\n\t\t\ttimeZone?: string;\n\t\t};\n\t};\n};\n\nexport function addNextOccurrence(items: RecurrentEvent[]) {\n\tfor (const item of items) {\n\t\tif (item.recurrence) {\n\t\t\tlet eventRecurrence;\n\t\t\ttry {\n\t\t\t\teventRecurrence = item.recurrence.find((r) => r.toUpperCase().startsWith('RRULE'));\n\n\t\t\t\tif (!eventRecurrence) continue;\n\n\t\t\t\tconst start = moment(item.start.dateTime || item.end.date).utc();\n\t\t\t\tconst end = moment(item.end.dateTime || item.end.date).utc();\n\n\t\t\t\tconst rruleWithStartDate = `DTSTART:${start.format(\n\t\t\t\t\t'YYYYMMDDTHHmmss',\n\t\t\t\t)}Z\\n${eventRecurrence}`;\n\n\t\t\t\tconst rrule = RRule.fromString(rruleWithStartDate);\n\n\t\t\t\tconst until = rrule.options?.until;\n\n\t\t\t\tconst now = moment().utc();\n\n\t\t\t\tif (until && moment(until).isBefore(now)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst nextDate = rrule.after(now.toDate(), false);\n\n\t\t\t\tif (nextDate) {\n\t\t\t\t\tconst nextStart = moment(nextDate);\n\n\t\t\t\t\tconst duration = moment.duration(moment(end).diff(moment(start)));\n\t\t\t\t\tconst nextEnd = moment(nextStart).add(duration);\n\n\t\t\t\t\titem.nextOccurrence = {\n\t\t\t\t\t\tstart: {\n\t\t\t\t\t\t\tdateTime: nextStart.format(),\n\t\t\t\t\t\t\ttimeZone: item.start.timeZone,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tend: {\n\t\t\t\t\t\t\tdateTime: nextEnd.format(),\n\t\t\t\t\t\t\ttimeZone: item.end.timeZone,\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.log(`Error adding next occurrence ${eventRecurrence}`);\n\t\t\t}\n\t\t}\n\t}\n\treturn items;\n}\n\nconst hasTimezone = (date: string) => date.endsWith('Z') || /\\+\\d{2}:\\d{2}$/.test(date);\n\nexport function addTimezoneToDate(date: string, timezone: string) {\n\tif (hasTimezone(date)) return date;\n\treturn moment.tz(date, timezone).utc().format();\n}\n\nasync function requestWithRetries(\n\tnode: INode,\n\trequestFn: () => Promise<any>,\n\tretryCount: number = 0,\n\tmaxRetries: number = 10,\n\titemIndex: number = 0,\n): Promise<any> {\n\ttry {\n\t\treturn await requestFn();\n\t} catch (error) {\n\t\tif (!(error instanceof NodeApiError)) {\n\t\t\tthrow new NodeOperationError(node, error.message, { itemIndex });\n\t\t}\n\n\t\tif (retryCount >= maxRetries) throw error;\n\n\t\tif (error.httpCode === '403' || error.httpCode === '429') {\n\t\t\tconst delay = 1000 * Math.pow(2, retryCount);\n\n\t\t\tconsole.log(`Rate limit hit. Retrying in ${delay}ms... (Attempt ${retryCount + 1})`);\n\n\t\t\tawait sleep(delay);\n\t\t\treturn await requestWithRetries(node, requestFn, retryCount + 1, maxRetries, itemIndex);\n\t\t}\n\n\t\tthrow error;\n\t}\n}\n\nexport async function googleApiRequestWithRetries({\n\tcontext,\n\tmethod,\n\tresource,\n\tbody = {},\n\tqs = {},\n\turi,\n\theaders = {},\n\titemIndex = 0,\n}: {\n\tcontext: IExecuteFunctions | ILoadOptionsFunctions | IPollFunctions;\n\tmethod: IHttpRequestMethods;\n\tresource: string;\n\tbody?: any;\n\tqs?: IDataObject;\n\turi?: string;\n\theaders?: IDataObject;\n\titemIndex?: number;\n}) {\n\tconst requestFn = async (): Promise<any> => {\n\t\treturn await googleApiRequest.call(context, method, resource, body, qs, uri, headers);\n\t};\n\n\tconst retryCount = 0;\n\tconst maxRetries = 10;\n\n\treturn await requestWithRetries(context.getNode(), requestFn, retryCount, maxRetries, itemIndex);\n}\n\nexport const eventExtendYearIntoFuture = (\n\tdata: RecurringEventInstance[],\n\ttimezone: string,\n\tcurrentYear?: number, // for testing purposes\n) => {\n\tconst thisYear = currentYear || moment().tz(timezone).year();\n\n\treturn data.some((event) => {\n\t\tif (!event.recurringEventId) return false;\n\n\t\tconst eventStart = event.start.dateTime || event.start.date;\n\n\t\tconst eventDateTime = moment(eventStart).tz(timezone);\n\t\tif (!eventDateTime.isValid()) return false;\n\n\t\tconst targetYear = eventDateTime.year();\n\n\t\tif (targetYear - thisYear >= 1) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t});\n};\n\nexport function dateObjectToISO<T>(date: T): string {\n\tif (date instanceof DateTime) return date.toISO();\n\tif (date instanceof Date) return date.toISOString();\n\treturn date as string;\n}\n"],"mappings":"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","names":["moment"]}