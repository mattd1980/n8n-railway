{"version":3,"sources":["../../../../../../../nodes/Google/Drive/v2/actions/file/download.operation.ts"],"sourcesContent":["import type {\n\tIExecuteFunctions,\n\tIBinaryKeyData,\n\tIDataObject,\n\tINodeExecutionData,\n\tINodeProperties,\n} from 'n8n-workflow';\n\nimport { updateDisplayOptions } from '@utils/utilities';\n\nimport { googleApiRequest } from '../../transport';\nimport { fileRLC } from '../common.descriptions';\n\nconst properties: INodeProperties[] = [\n\t{\n\t\t...fileRLC,\n\t\tdescription: 'The file to download',\n\t},\n\t{\n\t\tdisplayName: 'Options',\n\t\tname: 'options',\n\t\ttype: 'collection',\n\t\tplaceholder: 'Add option',\n\t\tdefault: {},\n\t\toptions: [\n\t\t\t{\n\t\t\t\tdisplayName: 'Put Output File in Field',\n\t\t\t\tname: 'binaryPropertyName',\n\t\t\t\ttype: 'string',\n\t\t\t\tplaceholder: 'e.g. data',\n\t\t\t\tdefault: 'data',\n\t\t\t\tdescription: 'Use this field name in the following nodes, to use the binary file data',\n\t\t\t\thint: 'The name of the output binary field to put the file in',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Google File Conversion',\n\t\t\t\tname: 'googleFileConversion',\n\t\t\t\ttype: 'fixedCollection',\n\t\t\t\ttypeOptions: {\n\t\t\t\t\tmultipleValues: false,\n\t\t\t\t},\n\t\t\t\tdefault: {},\n\t\t\t\tplaceholder: 'Add Conversion',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tdisplayName: 'Conversion',\n\t\t\t\t\t\tname: 'conversion',\n\t\t\t\t\t\tvalues: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdisplayName: 'Google Docs',\n\t\t\t\t\t\t\t\tname: 'docsToFormat',\n\t\t\t\t\t\t\t\ttype: 'options',\n\n\t\t\t\t\t\t\t\toptions: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'HTML',\n\t\t\t\t\t\t\t\t\t\tvalue: 'text/html',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'MS Word Document',\n\t\t\t\t\t\t\t\t\t\tvalue:\n\t\t\t\t\t\t\t\t\t\t\t'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'Open Office Document',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/vnd.oasis.opendocument.text',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'PDF',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/pdf',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t// eslint-disable-next-line n8n-nodes-base/node-param-display-name-miscased\n\t\t\t\t\t\t\t\t\t\tname: 'Rich Text (rtf)',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/rtf',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t// eslint-disable-next-line n8n-nodes-base/node-param-display-name-miscased\n\t\t\t\t\t\t\t\t\t\tname: 'Text (txt)',\n\t\t\t\t\t\t\t\t\t\tvalue: 'text/plain',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\tdefault: 'text/html',\n\t\t\t\t\t\t\t\tdescription: 'Format used to export when downloading Google Docs files',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdisplayName: 'Google Drawings',\n\t\t\t\t\t\t\t\tname: 'drawingsToFormat',\n\t\t\t\t\t\t\t\ttype: 'options',\n\t\t\t\t\t\t\t\toptions: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'JPEG',\n\t\t\t\t\t\t\t\t\t\tvalue: 'image/jpeg',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'PDF',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/pdf',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'PNG',\n\t\t\t\t\t\t\t\t\t\tvalue: 'image/png',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'SVG',\n\t\t\t\t\t\t\t\t\t\tvalue: 'image/svg+xml',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\tdefault: 'image/jpeg',\n\t\t\t\t\t\t\t\tdescription: 'Format used to export when downloading Google Drawings files',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdisplayName: 'Google Slides',\n\t\t\t\t\t\t\t\tname: 'slidesToFormat',\n\t\t\t\t\t\t\t\ttype: 'options',\n\t\t\t\t\t\t\t\toptions: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'MS PowerPoint',\n\t\t\t\t\t\t\t\t\t\tvalue:\n\t\t\t\t\t\t\t\t\t\t\t'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'OpenOffice Presentation',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/vnd.oasis.opendocument.presentation',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'PDF',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/pdf',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\t'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n\t\t\t\t\t\t\t\tdescription: 'Format used to export when downloading Google Slides files',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdisplayName: 'Google Sheets',\n\t\t\t\t\t\t\t\tname: 'sheetsToFormat',\n\t\t\t\t\t\t\t\ttype: 'options',\n\t\t\t\t\t\t\t\toptions: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'CSV',\n\t\t\t\t\t\t\t\t\t\tvalue: 'text/csv',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'MS Excel',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'Open Office Sheet',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/vnd.oasis.opendocument.spreadsheet',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tname: 'PDF',\n\t\t\t\t\t\t\t\t\t\tvalue: 'application/pdf',\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\tdefault: 'text/csv',\n\t\t\t\t\t\t\t\tdescription: 'Format used to export when downloading Google Sheets files',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'File Name',\n\t\t\t\tname: 'fileName',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: '',\n\t\t\t\tdescription: 'File name. Ex: data.pdf.',\n\t\t\t},\n\t\t],\n\t},\n];\n\nconst displayOptions = {\n\tshow: {\n\t\tresource: ['file'],\n\t\toperation: ['download'],\n\t},\n};\n\nexport const description = updateDisplayOptions(displayOptions, properties);\n\nexport async function execute(\n\tthis: IExecuteFunctions,\n\ti: number,\n\titem: INodeExecutionData,\n): Promise<INodeExecutionData[]> {\n\tconst fileId = this.getNodeParameter('fileId', i, undefined, {\n\t\textractValue: true,\n\t}) as string;\n\n\tconst downloadOptions = this.getNodeParameter('options', i);\n\n\tconst requestOptions = {\n\t\tuseStream: true,\n\t\treturnFullResponse: true,\n\t\tencoding: 'arraybuffer',\n\t\tjson: false,\n\t};\n\n\tconst file = await googleApiRequest.call(\n\t\tthis,\n\t\t'GET',\n\t\t`/drive/v3/files/${fileId}`,\n\t\t{},\n\t\t{ fields: 'mimeType,name', supportsTeamDrives: true, supportsAllDrives: true },\n\t);\n\tlet response;\n\n\tif (file.mimeType?.includes('vnd.google-apps')) {\n\t\tconst parameterKey = 'options.googleFileConversion.conversion';\n\t\tconst type = file.mimeType.split('.')[2];\n\t\tlet mime;\n\t\tif (type === 'document') {\n\t\t\tmime = this.getNodeParameter(\n\t\t\t\t`${parameterKey}.docsToFormat`,\n\t\t\t\ti,\n\t\t\t\t'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n\t\t\t) as string;\n\t\t} else if (type === 'presentation') {\n\t\t\tmime = this.getNodeParameter(\n\t\t\t\t`${parameterKey}.slidesToFormat`,\n\t\t\t\ti,\n\t\t\t\t'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n\t\t\t) as string;\n\t\t} else if (type === 'spreadsheet') {\n\t\t\tmime = this.getNodeParameter(\n\t\t\t\t`${parameterKey}.sheetsToFormat`,\n\t\t\t\ti,\n\t\t\t\t'application/x-vnd.oasis.opendocument.spreadsheet',\n\t\t\t) as string;\n\t\t} else {\n\t\t\tmime = this.getNodeParameter(`${parameterKey}.drawingsToFormat`, i, 'image/jpeg') as string;\n\t\t}\n\t\tresponse = await googleApiRequest.call(\n\t\t\tthis,\n\t\t\t'GET',\n\t\t\t`/drive/v3/files/${fileId}/export`,\n\t\t\t{},\n\t\t\t{ mimeType: mime, supportsAllDrives: true },\n\t\t\tundefined,\n\t\t\trequestOptions,\n\t\t);\n\t} else {\n\t\tresponse = await googleApiRequest.call(\n\t\t\tthis,\n\t\t\t'GET',\n\t\t\t`/drive/v3/files/${fileId}`,\n\t\t\t{},\n\t\t\t{ alt: 'media', supportsAllDrives: true },\n\t\t\tundefined,\n\t\t\trequestOptions,\n\t\t);\n\t}\n\n\tconst mimeType =\n\t\t(response.headers as IDataObject)?.['content-type'] ?? file.mimeType ?? undefined;\n\tconst fileName = downloadOptions.fileName ?? file.name ?? undefined;\n\n\tconst newItem: INodeExecutionData = {\n\t\tjson: item.json,\n\t\tbinary: {},\n\t};\n\n\tif (item.binary !== undefined) {\n\t\t// Create a shallow copy of the binary data so that the old\n\t\t// data references which do not get changed still stay behind\n\t\t// but the incoming data does not get changed.\n\t\tObject.assign(newItem.binary as IBinaryKeyData, item.binary);\n\t}\n\n\titem = newItem;\n\n\tconst dataPropertyNameDownload = (downloadOptions.binaryPropertyName as string) || 'data';\n\n\titem.binary![dataPropertyNameDownload] = await this.helpers.prepareBinaryData(\n\t\tresponse.body as Buffer,\n\t\tfileName as string,\n\t\tmimeType as string,\n\t);\n\n\tconst executionData = this.helpers.constructExecutionMetaData([item], { itemData: { item: i } });\n\n\treturn executionData;\n}\n"],"mappings":"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","names":[]}