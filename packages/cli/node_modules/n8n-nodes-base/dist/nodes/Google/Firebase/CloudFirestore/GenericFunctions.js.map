{"version":3,"sources":["../../../../../nodes/Google/Firebase/CloudFirestore/GenericFunctions.ts"],"sourcesContent":["import moment from 'moment-timezone';\nimport type {\n\tIExecuteFunctions,\n\tILoadOptionsFunctions,\n\tIDataObject,\n\tJsonObject,\n\tIHttpRequestMethods,\n\tIRequestOptions,\n} from 'n8n-workflow';\nimport { NodeApiError } from 'n8n-workflow';\n\nimport { getGoogleAccessToken } from '../../GenericFunctions';\n\nexport async function googleApiRequest(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions,\n\tmethod: IHttpRequestMethods,\n\tresource: string,\n\tbody: any = {},\n\tqs: IDataObject = {},\n\turi: string | null = null,\n): Promise<any> {\n\tconst options: IRequestOptions = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json',\n\t\t},\n\t\tmethod,\n\t\tbody,\n\t\tqs,\n\t\tqsStringifyOptions: {\n\t\t\tarrayFormat: 'repeat',\n\t\t},\n\t\turi: uri || `https://firestore.googleapis.com/v1/projects${resource}`,\n\t\tjson: true,\n\t};\n\ttry {\n\t\tif (Object.keys(body as IDataObject).length === 0) {\n\t\t\tdelete options.body;\n\t\t}\n\n\t\tlet credentialType = 'googleFirebaseCloudFirestoreOAuth2Api';\n\t\tconst authentication = this.getNodeParameter('authentication', 0) as string;\n\n\t\tif (authentication === 'serviceAccount') {\n\t\t\tconst credentials = await this.getCredentials('googleApi');\n\t\t\tcredentialType = 'googleApi';\n\n\t\t\tconst { access_token } = await getGoogleAccessToken.call(this, credentials, 'firestore');\n\n\t\t\t(options.headers as IDataObject).Authorization = `Bearer ${access_token}`;\n\t\t}\n\n\t\treturn await this.helpers.requestWithAuthentication.call(this, credentialType, options);\n\t} catch (error) {\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n}\n\nexport async function googleApiRequestAllItems(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions,\n\tpropertyName: string,\n\tmethod: IHttpRequestMethods,\n\tendpoint: string,\n\n\tbody: any = {},\n\tquery: IDataObject = {},\n\turi: string | null = null,\n): Promise<any> {\n\tconst returnData: IDataObject[] = [];\n\n\tlet responseData;\n\tquery.pageSize = 100;\n\n\tdo {\n\t\tresponseData = await googleApiRequest.call(this, method, endpoint, body, query, uri);\n\t\tquery.pageToken = responseData.nextPageToken;\n\t\treturnData.push.apply(returnData, responseData[propertyName] as IDataObject[]);\n\t} while (responseData.nextPageToken !== undefined && responseData.nextPageToken !== '');\n\n\treturn returnData;\n}\n\nconst isValidDate = (str: string) =>\n\tmoment(str, ['YYYY-MM-DD HH:mm:ss Z', moment.ISO_8601], true).isValid();\n\nconst protoKeys = ['__proto__', 'prototype', 'constructor'];\n\n// Both functions below were taken from Stack Overflow jsonToDocument was fixed as it was unable to handle null values correctly\n// https://stackoverflow.com/questions/62246410/how-to-convert-a-firestore-document-to-plain-json-and-vice-versa\n// Great thanks to https://stackoverflow.com/users/3915246/mahindar\nexport function jsonToDocument(value: string | number | IDataObject | IDataObject[]): IDataObject {\n\tif (value === 'true' || value === 'false' || typeof value === 'boolean') {\n\t\treturn { booleanValue: value };\n\t} else if (value === null) {\n\t\treturn { nullValue: null };\n\t} else if (value !== '' && !isNaN(value as number)) {\n\t\tif (value.toString().indexOf('.') !== -1) {\n\t\t\treturn { doubleValue: value };\n\t\t} else {\n\t\t\treturn { integerValue: value };\n\t\t}\n\t} else if (isValidDate(value as string)) {\n\t\tconst date = new Date(Date.parse(value as string));\n\t\treturn { timestampValue: date.toISOString() };\n\t} else if (typeof value === 'string') {\n\t\treturn { stringValue: value };\n\t} else if (value && value.constructor === Array) {\n\t\treturn { arrayValue: { values: value.map((v) => jsonToDocument(v)) } };\n\t} else if (typeof value === 'object') {\n\t\tconst obj: IDataObject = {};\n\t\tfor (const key of Object.keys(value)) {\n\t\t\tif (value.hasOwnProperty(key) && !protoKeys.includes(key)) {\n\t\t\t\tobj[key] = jsonToDocument((value as IDataObject)[key] as IDataObject);\n\t\t\t}\n\t\t}\n\t\treturn { mapValue: { fields: obj } };\n\t}\n\n\treturn {};\n}\n\nexport function documentToJson(fields: IDataObject): IDataObject {\n\tif (fields === undefined) return {};\n\tconst result = {};\n\tfor (const f of Object.keys(fields)) {\n\t\tconst key = f,\n\t\t\tvalue = fields[f],\n\t\t\tisDocumentType = [\n\t\t\t\t'stringValue',\n\t\t\t\t'booleanValue',\n\t\t\t\t'doubleValue',\n\t\t\t\t'integerValue',\n\t\t\t\t'timestampValue',\n\t\t\t\t'mapValue',\n\t\t\t\t'arrayValue',\n\t\t\t\t'nullValue',\n\t\t\t\t'geoPointValue',\n\t\t\t].find((t) => t === key);\n\t\tif (isDocumentType) {\n\t\t\tconst item = [\n\t\t\t\t'stringValue',\n\t\t\t\t'booleanValue',\n\t\t\t\t'doubleValue',\n\t\t\t\t'integerValue',\n\t\t\t\t'timestampValue',\n\t\t\t\t'nullValue',\n\t\t\t\t'geoPointValue',\n\t\t\t].find((t) => t === key);\n\t\t\tif (item) {\n\t\t\t\treturn value as IDataObject;\n\t\t\t} else if ('mapValue' === key) {\n\t\t\t\t//@ts-ignore\n\t\t\t\treturn documentToJson((value!.fields as IDataObject) || {});\n\t\t\t} else if ('arrayValue' === key) {\n\t\t\t\t// @ts-ignore\n\t\t\t\tconst list = value.values as IDataObject[];\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn !!list ? list.map((l) => documentToJson(l)) : [];\n\t\t\t}\n\t\t} else {\n\t\t\t// @ts-ignore\n\t\t\tresult[key] = documentToJson(value);\n\t\t}\n\t}\n\treturn result;\n}\n\nexport function fullDocumentToJson(data: IDataObject): IDataObject {\n\tif (data === undefined) {\n\t\treturn data;\n\t}\n\n\treturn {\n\t\t_name: data.name,\n\t\t_id: data.id,\n\t\t_createTime: data.createTime,\n\t\t_updateTime: data.updateTime,\n\t\t...documentToJson(data.fields as IDataObject),\n\t};\n}\n"],"mappings":"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","names":["moment"]}