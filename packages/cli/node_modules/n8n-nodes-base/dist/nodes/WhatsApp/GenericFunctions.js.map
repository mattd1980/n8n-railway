{"version":3,"sources":["../../../nodes/WhatsApp/GenericFunctions.ts"],"sourcesContent":["import type {\n\tIDataObject,\n\tIExecuteFunctions,\n\tIHookFunctions,\n\tIHttpRequestMethods,\n\tIHttpRequestOptions,\n\tILoadOptionsFunctions,\n\tIWebhookFunctions,\n\tJsonObject,\n} from 'n8n-workflow';\nimport { NodeApiError } from 'n8n-workflow';\n\nimport type {\n\tWhatsAppAppWebhookSubscriptionsResponse,\n\tWhatsAppAppWebhookSubscription,\n} from './types';\nimport type { SendAndWaitConfig } from '../../utils/sendAndWait/utils';\nimport { createUtmCampaignLink } from '../../utils/utilities';\nexport const WHATSAPP_BASE_URL = 'https://graph.facebook.com/v13.0/';\n\nasync function appAccessTokenRead(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions | IWebhookFunctions,\n): Promise<{ access_token: string }> {\n\tconst credentials = await this.getCredentials('whatsAppTriggerApi');\n\n\tconst options: IHttpRequestOptions = {\n\t\theaders: {\n\t\t\t'content-type': 'application/x-www-form-urlencoded',\n\t\t},\n\t\tmethod: 'POST',\n\t\tbody: {\n\t\t\tclient_id: credentials.clientId,\n\t\t\tclient_secret: credentials.clientSecret,\n\t\t\tgrant_type: 'client_credentials',\n\t\t},\n\t\turl: 'https://graph.facebook.com/v19.0/oauth/access_token',\n\t\tjson: true,\n\t};\n\ttry {\n\t\treturn await this.helpers.httpRequest.call(this, options);\n\t} catch (error) {\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n}\n\nasync function whatsappApiRequest(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions | IWebhookFunctions,\n\tmethod: IHttpRequestMethods,\n\tresource: string,\n\tbody?: { type: 'json'; payload: IDataObject } | { type: 'form'; payload: IDataObject },\n\tqs: IDataObject = {},\n): Promise<any> {\n\tconst tokenResponse = await appAccessTokenRead.call(this);\n\tconst appAccessToken = tokenResponse.access_token;\n\n\tconst options: IHttpRequestOptions = {\n\t\theaders: {\n\t\t\taccept: 'application/json',\n\t\t\tauthorization: `Bearer ${appAccessToken}`,\n\t\t},\n\t\tmethod,\n\t\tqs,\n\t\tbody: body?.payload,\n\t\turl: `https://graph.facebook.com/v19.0${resource}`,\n\t\tjson: true,\n\t};\n\n\ttry {\n\t\treturn await this.helpers.httpRequest.call(this, options);\n\t} catch (error) {\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n}\n\nexport async function appWebhookSubscriptionList(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions | IWebhookFunctions,\n\tappId: string,\n): Promise<WhatsAppAppWebhookSubscription[]> {\n\tconst response = (await whatsappApiRequest.call(\n\t\tthis,\n\t\t'GET',\n\t\t`/${appId}/subscriptions`,\n\t)) as WhatsAppAppWebhookSubscriptionsResponse;\n\treturn response.data;\n}\n\nexport async function appWebhookSubscriptionCreate(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions | IWebhookFunctions,\n\tappId: string,\n\tsubscription: IDataObject,\n) {\n\treturn await whatsappApiRequest.call(this, 'POST', `/${appId}/subscriptions`, {\n\t\ttype: 'form',\n\t\tpayload: { ...subscription },\n\t});\n}\n\nexport async function appWebhookSubscriptionDelete(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions | IWebhookFunctions,\n\tappId: string,\n\tobject: string,\n) {\n\treturn await whatsappApiRequest.call(this, 'DELETE', `/${appId}/subscriptions`, {\n\t\ttype: 'form',\n\t\tpayload: { object },\n\t});\n}\n\nexport const createMessage = (\n\tsendAndWaitConfig: SendAndWaitConfig,\n\tphoneNumberId: string,\n\trecipientPhoneNumber: string,\n\tinstanceId: string,\n): IHttpRequestOptions => {\n\tconst buttons = sendAndWaitConfig.options.map((option) => {\n\t\treturn `*${option.label}:*\\n_${sendAndWaitConfig.url}?approved=${option.value}_\\n\\n`;\n\t});\n\n\tlet n8nAttribution: string = '';\n\tif (sendAndWaitConfig.appendAttribution) {\n\t\tconst attributionText = 'This message was sent automatically with ';\n\t\tconst link = createUtmCampaignLink('n8n-nodes-base.whatsapp', instanceId);\n\t\tn8nAttribution = `\\n\\n${attributionText}${link}`;\n\t}\n\n\treturn {\n\t\tbaseURL: WHATSAPP_BASE_URL,\n\t\tmethod: 'POST',\n\t\turl: `${phoneNumberId}/messages`,\n\t\tbody: {\n\t\t\tmessaging_product: 'whatsapp',\n\t\t\ttext: {\n\t\t\t\tbody: `${sendAndWaitConfig.message}\\n\\n${buttons.join('')}${n8nAttribution}`,\n\t\t\t},\n\t\t\ttype: 'text',\n\t\t\tto: recipientPhoneNumber,\n\t\t},\n\t};\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUA,0BAA6B;AAO7B,uBAAsC;AAC/B,MAAM,oBAAoB;AAEjC,eAAe,qBAEsB;AACpC,QAAM,cAAc,MAAM,KAAK,eAAe,oBAAoB;AAElE,QAAM,UAA+B;AAAA,IACpC,SAAS;AAAA,MACR,gBAAgB;AAAA,IACjB;AAAA,IACA,QAAQ;AAAA,IACR,MAAM;AAAA,MACL,WAAW,YAAY;AAAA,MACvB,eAAe,YAAY;AAAA,MAC3B,YAAY;AAAA,IACb;AAAA,IACA,KAAK;AAAA,IACL,MAAM;AAAA,EACP;AACA,MAAI;AACH,WAAO,MAAM,KAAK,QAAQ,YAAY,KAAK,MAAM,OAAO;AAAA,EACzD,SAAS,OAAO;AACf,UAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG,KAAmB;AAAA,EAC3D;AACD;AAEA,eAAe,mBAEd,QACA,UACA,MACA,KAAkB,CAAC,GACJ;AACf,QAAM,gBAAgB,MAAM,mBAAmB,KAAK,IAAI;AACxD,QAAM,iBAAiB,cAAc;AAErC,QAAM,UAA+B;AAAA,IACpC,SAAS;AAAA,MACR,QAAQ;AAAA,MACR,eAAe,UAAU,cAAc;AAAA,IACxC;AAAA,IACA;AAAA,IACA;AAAA,IACA,MAAM,MAAM;AAAA,IACZ,KAAK,mCAAmC,QAAQ;AAAA,IAChD,MAAM;AAAA,EACP;AAEA,MAAI;AACH,WAAO,MAAM,KAAK,QAAQ,YAAY,KAAK,MAAM,OAAO;AAAA,EACzD,SAAS,OAAO;AACf,UAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG,KAAmB;AAAA,EAC3D;AACD;AAEA,eAAsB,2BAErB,OAC4C;AAC5C,QAAM,WAAY,MAAM,mBAAmB;AAAA,IAC1C;AAAA,IACA;AAAA,IACA,IAAI,KAAK;AAAA,EACV;AACA,SAAO,SAAS;AACjB;AAEA,eAAsB,6BAErB,OACA,cACC;AACD,SAAO,MAAM,mBAAmB,KAAK,MAAM,QAAQ,IAAI,KAAK,kBAAkB;AAAA,IAC7E,MAAM;AAAA,IACN,SAAS,EAAE,GAAG,aAAa;AAAA,EAC5B,CAAC;AACF;AAEA,eAAsB,6BAErB,OACA,QACC;AACD,SAAO,MAAM,mBAAmB,KAAK,MAAM,UAAU,IAAI,KAAK,kBAAkB;AAAA,IAC/E,MAAM;AAAA,IACN,SAAS,EAAE,OAAO;AAAA,EACnB,CAAC;AACF;AAEO,MAAM,gBAAgB,CAC5B,mBACA,eACA,sBACA,eACyB;AACzB,QAAM,UAAU,kBAAkB,QAAQ,IAAI,CAAC,WAAW;AACzD,WAAO,IAAI,OAAO,KAAK;AAAA,GAAQ,kBAAkB,GAAG,aAAa,OAAO,KAAK;AAAA;AAAA;AAAA,EAC9E,CAAC;AAED,MAAI,iBAAyB;AAC7B,MAAI,kBAAkB,mBAAmB;AACxC,UAAM,kBAAkB;AACxB,UAAM,WAAO,wCAAsB,2BAA2B,UAAU;AACxE,qBAAiB;AAAA;AAAA,EAAO,eAAe,GAAG,IAAI;AAAA,EAC/C;AAEA,SAAO;AAAA,IACN,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,KAAK,GAAG,aAAa;AAAA,IACrB,MAAM;AAAA,MACL,mBAAmB;AAAA,MACnB,MAAM;AAAA,QACL,MAAM,GAAG,kBAAkB,OAAO;AAAA;AAAA,EAAO,QAAQ,KAAK,EAAE,CAAC,GAAG,cAAc;AAAA,MAC3E;AAAA,MACA,MAAM;AAAA,MACN,IAAI;AAAA,IACL;AAAA,EACD;AACD;","names":[]}