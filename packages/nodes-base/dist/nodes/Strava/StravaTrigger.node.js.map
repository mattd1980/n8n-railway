{"version":3,"sources":["../../../nodes/Strava/StravaTrigger.node.ts"],"sourcesContent":["import { randomBytes } from 'crypto';\nimport type {\n\tIHookFunctions,\n\tIWebhookFunctions,\n\tIDataObject,\n\tINodeType,\n\tINodeTypeDescription,\n\tIWebhookResponseData,\n} from 'n8n-workflow';\nimport { NodeConnectionTypes } from 'n8n-workflow';\n\nimport { stravaApiRequest } from './GenericFunctions';\n\nexport class StravaTrigger implements INodeType {\n\tdescription: INodeTypeDescription = {\n\t\tdisplayName: 'Strava Trigger',\n\t\tname: 'stravaTrigger',\n\t\ticon: 'file:strava.svg',\n\t\tgroup: ['trigger'],\n\t\tversion: 1,\n\t\tdescription: 'Starts the workflow when Strava events occur',\n\t\tdefaults: {\n\t\t\tname: 'Strava Trigger',\n\t\t},\n\t\tinputs: [],\n\t\toutputs: [NodeConnectionTypes.Main],\n\t\tcredentials: [\n\t\t\t{\n\t\t\t\tname: 'stravaOAuth2Api',\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t],\n\t\twebhooks: [\n\t\t\t{\n\t\t\t\tname: 'setup',\n\t\t\t\thttpMethod: 'GET',\n\t\t\t\tresponseMode: 'onReceived',\n\t\t\t\tpath: 'webhook',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'default',\n\t\t\t\thttpMethod: 'POST',\n\t\t\t\tresponseMode: 'onReceived',\n\t\t\t\tpath: 'webhook',\n\t\t\t},\n\t\t],\n\t\tproperties: [\n\t\t\t{\n\t\t\t\tdisplayName: 'Object',\n\t\t\t\tname: 'object',\n\t\t\t\ttype: 'options',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: '[All]',\n\t\t\t\t\t\tvalue: '*',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Activity',\n\t\t\t\t\t\tvalue: 'activity',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Athlete',\n\t\t\t\t\t\tvalue: 'athlete',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: '*',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Event',\n\t\t\t\tname: 'event',\n\t\t\t\ttype: 'options',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: '[All]',\n\t\t\t\t\t\tvalue: '*',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Created',\n\t\t\t\t\t\tvalue: 'create',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Deleted',\n\t\t\t\t\t\tvalue: 'delete',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Updated',\n\t\t\t\t\t\tvalue: 'update',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: '*',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Resolve Data',\n\t\t\t\tname: 'resolveData',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: true,\n\t\t\t\t// eslint-disable-next-line n8n-nodes-base/node-param-description-boolean-without-whether\n\t\t\t\tdescription:\n\t\t\t\t\t'By default the webhook-data only contain the Object ID. If this option gets activated, it will resolve the data automatically.',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Options',\n\t\t\t\tname: 'options',\n\t\t\t\ttype: 'collection',\n\t\t\t\tplaceholder: 'Add option',\n\t\t\t\tdefault: {},\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tdisplayName: 'Delete If Exist',\n\t\t\t\t\t\tname: 'deleteIfExist',\n\t\t\t\t\t\ttype: 'boolean',\n\t\t\t\t\t\tdefault: false,\n\t\t\t\t\t\t// eslint-disable-next-line n8n-nodes-base/node-param-description-boolean-without-whether\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t'Strava allows just one subscription at all times. If you want to delete the current subscription to make room for a new subscription with the current parameters, set this parameter to true. Keep in mind this is a destructive operation.',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t],\n\t};\n\n\twebhookMethods = {\n\t\tdefault: {\n\t\t\tasync checkExists(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookUrl = this.getNodeWebhookUrl('default');\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\t// Check all the webhooks which exist already if it is identical to the\n\t\t\t\t// one that is supposed to get created.\n\t\t\t\tconst endpoint = '/push_subscriptions';\n\n\t\t\t\tconst webhooks = await stravaApiRequest.call(this, 'GET', endpoint, {});\n\n\t\t\t\tfor (const webhook of webhooks) {\n\t\t\t\t\tif (webhook.callback_url === webhookUrl) {\n\t\t\t\t\t\twebhookData.webhookId = webhook.id;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tasync create(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst webhookUrl = this.getNodeWebhookUrl('default');\n\n\t\t\t\tconst endpoint = '/push_subscriptions';\n\n\t\t\t\tconst body = {\n\t\t\t\t\tcallback_url: webhookUrl,\n\t\t\t\t\tverify_token: randomBytes(20).toString('hex'),\n\t\t\t\t};\n\n\t\t\t\tlet responseData;\n\n\t\t\t\ttry {\n\t\t\t\t\tresponseData = await stravaApiRequest.call(this, 'POST', endpoint, body);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tif (error?.cause?.error) {\n\t\t\t\t\t\tconst errors = error?.cause?.error?.errors;\n\t\t\t\t\t\tfor (error of errors) {\n\t\t\t\t\t\t\t// if there is a subscription already created\n\t\t\t\t\t\t\tif (error.resource === 'PushSubscription' && error.code === 'already exists') {\n\t\t\t\t\t\t\t\tconst options = this.getNodeParameter('options') as IDataObject;\n\t\t\t\t\t\t\t\t//get the current subscription\n\t\t\t\t\t\t\t\tconst webhooks = await stravaApiRequest.call(\n\t\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t\t'GET',\n\t\t\t\t\t\t\t\t\t'/push_subscriptions',\n\t\t\t\t\t\t\t\t\t{},\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tif (options.deleteIfExist) {\n\t\t\t\t\t\t\t\t\t// delete the subscription\n\t\t\t\t\t\t\t\t\tawait stravaApiRequest.call(\n\t\t\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t\t\t'DELETE',\n\t\t\t\t\t\t\t\t\t\t`/push_subscriptions/${webhooks[0].id}`,\n\t\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\t\t// now there is room create a subscription with the n8n data\n\t\t\t\t\t\t\t\t\tconst requestBody = {\n\t\t\t\t\t\t\t\t\t\tcallback_url: webhookUrl,\n\t\t\t\t\t\t\t\t\t\tverify_token: randomBytes(20).toString('hex'),\n\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\tresponseData = await stravaApiRequest.call(\n\t\t\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t\t\t'POST',\n\t\t\t\t\t\t\t\t\t\t'/push_subscriptions',\n\t\t\t\t\t\t\t\t\t\trequestBody,\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\terror.message = `A subscription already exists [${webhooks[0].callback_url}]. If you want to delete this subscription and create a new one with the current parameters please go to options and set delete if exist to true`;\n\t\t\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!responseData) {\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (responseData.id === undefined) {\n\t\t\t\t\t// Required data is missing so was not successful\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\twebhookData.webhookId = responseData.id as string;\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tasync delete(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tif (webhookData.webhookId !== undefined) {\n\t\t\t\t\tconst endpoint = `/push_subscriptions/${webhookData.webhookId}`;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait stravaApiRequest.call(this, 'DELETE', endpoint);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Remove from the static workflow data so that it is clear\n\t\t\t\t\t// that no webhooks are registered anymore\n\t\t\t\t\tdelete webhookData.webhookId;\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t},\n\t\t},\n\t};\n\n\tasync webhook(this: IWebhookFunctions): Promise<IWebhookResponseData> {\n\t\tconst body = this.getBodyData();\n\t\tconst query = this.getQueryData() as IDataObject;\n\t\tconst object = this.getNodeParameter('object');\n\t\tconst event = this.getNodeParameter('event');\n\t\tconst resolveData = this.getNodeParameter('resolveData') as boolean;\n\n\t\tlet objectType, eventType;\n\n\t\tif (object === '*') {\n\t\t\tobjectType = ['activity', 'athlete'];\n\t\t} else {\n\t\t\tobjectType = [object];\n\t\t}\n\n\t\tif (event === '*') {\n\t\t\teventType = ['create', 'update', 'delete'];\n\t\t} else {\n\t\t\teventType = [event];\n\t\t}\n\n\t\tif (this.getWebhookName() === 'setup') {\n\t\t\tif (query['hub.challenge']) {\n\t\t\t\t// Is a create webhook confirmation request\n\t\t\t\tconst res = this.getResponseObject();\n\t\t\t\tres.status(200).json({ 'hub.challenge': query['hub.challenge'] }).end();\n\t\t\t\treturn {\n\t\t\t\t\tnoWebhookResponse: true,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tif (object !== '*' && !objectType.includes(body.object_type as string)) {\n\t\t\treturn {};\n\t\t}\n\n\t\tif (event !== '*' && !eventType.includes(body.aspect_type as string)) {\n\t\t\treturn {};\n\t\t}\n\n\t\tif (resolveData && body.aspect_type !== 'delete') {\n\t\t\tlet endpoint = `/athletes/${body.object_id}/stats`;\n\t\t\tif (body.object_type === 'activity') {\n\t\t\t\tendpoint = `/activities/${body.object_id}`;\n\t\t\t}\n\t\t\tbody.object_data = await stravaApiRequest.call(this, 'GET', endpoint);\n\t\t}\n\n\t\treturn {\n\t\t\tworkflowData: [this.helpers.returnJsonArray(body)],\n\t\t};\n\t}\n}\n"],"mappings":"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","names":[]}