{"version":3,"sources":["../../../nodes/Wise/GenericFunctions.ts"],"sourcesContent":["import { createSign } from 'crypto';\nimport type {\n\tIDataObject,\n\tIExecuteFunctions,\n\tIHookFunctions,\n\tIHttpRequestOptions,\n\tILoadOptionsFunctions,\n\tJsonObject,\n} from 'n8n-workflow';\nimport { NodeApiError } from 'n8n-workflow';\n\n/**\n * Make an authenticated API request to Wise.\n */\nexport async function wiseApiRequest(\n\tthis: IHookFunctions | IExecuteFunctions | ILoadOptionsFunctions,\n\tmethod: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'HEAD' | 'PATCH',\n\tendpoint: string,\n\tbody: IDataObject = {},\n\tqs: IDataObject = {},\n\toption: IDataObject = {},\n) {\n\tconst { apiToken, environment, privateKey } = await this.getCredentials<{\n\t\tapiToken: string;\n\t\tenvironment: 'live' | 'test';\n\t\tprivateKey?: string;\n\t}>('wiseApi');\n\n\tconst rootUrl =\n\t\tenvironment === 'live'\n\t\t\t? 'https://api.transferwise.com/'\n\t\t\t: 'https://api.sandbox.transferwise.tech/';\n\n\tconst options: IHttpRequestOptions = {\n\t\theaders: {\n\t\t\t'user-agent': 'n8n',\n\t\t\tAuthorization: `Bearer ${apiToken}`,\n\t\t},\n\t\tmethod,\n\t\turl: `${rootUrl}${endpoint}`,\n\t\tqs,\n\t\tbody,\n\t\tjson: true,\n\t\treturnFullResponse: true,\n\t\tignoreHttpStatusErrors: true,\n\t};\n\n\tif (!Object.keys(body).length) {\n\t\tdelete options.body;\n\t}\n\n\tif (!Object.keys(qs).length) {\n\t\tdelete options.qs;\n\t}\n\n\tif (option.encoding) {\n\t\tdelete options.json;\n\t}\n\n\tif (Object.keys(option)) {\n\t\tObject.assign(options, option);\n\t}\n\n\tlet response;\n\ttry {\n\t\tresponse = await this.helpers.httpRequest(options);\n\t} catch (error) {\n\t\tdelete error.config;\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n\n\tif (response.statusCode >= 200 && response.statusCode < 300) {\n\t\treturn response.body;\n\t}\n\n\t// Request requires SCA approval\n\tif (response.statusCode === 403 && response.headers['x-2fa-approval']) {\n\t\tif (!privateKey) {\n\t\t\tthrow new NodeApiError(this.getNode(), {\n\t\t\t\tmessage:\n\t\t\t\t\t'This request requires Strong Customer Authentication (SCA). Please add a key pair to your account and n8n credentials. See https://api-docs.transferwise.com/#strong-customer-authentication-personal-token',\n\t\t\t\theaders: response.headers,\n\t\t\t\tbody: response.body,\n\t\t\t});\n\t\t}\n\t\t// Sign the x-2fa-approval\n\t\tconst oneTimeToken = response.headers['x-2fa-approval'] as string;\n\t\tconst signerObject = createSign('RSA-SHA256').update(oneTimeToken);\n\t\ttry {\n\t\t\tconst signature = signerObject.sign(privateKey, 'base64');\n\t\t\tdelete option.ignoreHttpStatusErrors;\n\t\t\toptions.headers = {\n\t\t\t\t...options.headers,\n\t\t\t\t'X-Signature': signature,\n\t\t\t\t'x-2fa-approval': oneTimeToken,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tthrow new NodeApiError(this.getNode(), {\n\t\t\t\tmessage: 'Error signing SCA request, check your private key',\n\t\t\t\t...(error as JsonObject),\n\t\t\t});\n\t\t}\n\t\t// Retry the request with signed token\n\t\ttry {\n\t\t\tresponse = await this.helpers.httpRequest(options);\n\t\t\treturn response.body;\n\t\t} catch (error) {\n\t\t\tthrow new NodeApiError(this.getNode(), {\n\t\t\t\tmessage: 'SCA request failed, check your private key is valid',\n\t\t\t});\n\t\t}\n\t} else {\n\t\tthrow new NodeApiError(this.getNode(), {\n\t\t\t...(response as JsonObject),\n\t\t\tmessage: response.statusMessage,\n\t\t});\n\t}\n}\n\nexport function getTriggerName(eventName: string) {\n\tconst events: IDataObject = {\n\t\ttranferStateChange: 'transfers#state-change',\n\t\ttransferActiveCases: 'transfers#active-cases',\n\t\tbalanceCredit: 'balances#credit',\n\t\tbalanceUpdate: 'balances#update',\n\t};\n\treturn events[eventName];\n}\n\nexport type BorderlessAccount = {\n\tid: number;\n\tbalances: Array<{ currency: string }>;\n};\n\nexport type ExchangeRateAdditionalFields = {\n\tinterval: 'day' | 'hour' | 'minute';\n\trange: {\n\t\trangeProperties: { from: string; to: string };\n\t};\n\ttime: string;\n};\n\nexport type Profile = {\n\tid: number;\n\ttype: 'business' | 'personal';\n};\n\nexport type Recipient = {\n\tactive: boolean;\n\tid: number;\n\taccountHolderName: string;\n\tcountry: string | null;\n\tcurrency: string;\n\ttype: string;\n};\n\nexport type StatementAdditionalFields = {\n\tlineStyle: 'COMPACT' | 'FLAT';\n\trange: {\n\t\trangeProperties: { intervalStart: string; intervalEnd: string };\n\t};\n};\n\nexport type TransferFilters = {\n\t[key: string]: string | IDataObject;\n\trange: {\n\t\trangeProperties: { createdDateStart: string; createdDateEnd: string };\n\t};\n\tsourceCurrency: string;\n\tstatus: string;\n\ttargetCurrency: string;\n};\n\nexport const livePublicKey = `\n-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvO8vXV+JksBzZAY6GhSO\nXdoTCfhXaaiZ+qAbtaDBiu2AGkGVpmEygFmWP4Li9m5+Ni85BhVvZOodM9epgW3F\nbA5Q1SexvAF1PPjX4JpMstak/QhAgl1qMSqEevL8cmUeTgcMuVWCJmlge9h7B1CS\nD4rtlimGZozG39rUBDg6Qt2K+P4wBfLblL0k4C4YUdLnpGYEDIth+i8XsRpFlogx\nCAFyH9+knYsDbR43UJ9shtc42Ybd40Afihj8KnYKXzchyQ42aC8aZ/h5hyZ28yVy\nOj3Vos0VdBIs/gAyJ/4yyQFCXYte64I7ssrlbGRaco4nKF3HmaNhxwyKyJafz19e\nHwIDAQAB\n-----END PUBLIC KEY-----`;\n\nexport const testPublicKey = `\n-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwpb91cEYuyJNQepZAVfP\nZIlPZfNUefH+n6w9SW3fykqKu938cR7WadQv87oF2VuT+fDt7kqeRziTmPSUhqPU\nys/V2Q1rlfJuXbE+Gga37t7zwd0egQ+KyOEHQOpcTwKmtZ81ieGHynAQzsn1We3j\nwt760MsCPJ7GMT141ByQM+yW1Bx+4SG3IGjXWyqOWrcXsxAvIXkpUD/jK/L958Cg\nnZEgz0BSEh0QxYLITnW1lLokSx/dTianWPFEhMC9BgijempgNXHNfcVirg1lPSyg\nz7KqoKUN0oHqWLr2U1A+7kqrl6O2nx3CKs1bj1hToT1+p4kcMoHXA7kA+VBLUpEs\nVwIDAQAB\n-----END PUBLIC KEY-----`;\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAA2B;AAS3B,0BAA6B;AAK7B,eAAsB,eAErB,QACA,UACA,OAAoB,CAAC,GACrB,KAAkB,CAAC,GACnB,SAAsB,CAAC,GACtB;AACD,QAAM,EAAE,UAAU,aAAa,WAAW,IAAI,MAAM,KAAK,eAItD,SAAS;AAEZ,QAAM,UACL,gBAAgB,SACb,kCACA;AAEJ,QAAM,UAA+B;AAAA,IACpC,SAAS;AAAA,MACR,cAAc;AAAA,MACd,eAAe,UAAU,QAAQ;AAAA,IAClC;AAAA,IACA;AAAA,IACA,KAAK,GAAG,OAAO,GAAG,QAAQ;AAAA,IAC1B;AAAA,IACA;AAAA,IACA,MAAM;AAAA,IACN,oBAAoB;AAAA,IACpB,wBAAwB;AAAA,EACzB;AAEA,MAAI,CAAC,OAAO,KAAK,IAAI,EAAE,QAAQ;AAC9B,WAAO,QAAQ;AAAA,EAChB;AAEA,MAAI,CAAC,OAAO,KAAK,EAAE,EAAE,QAAQ;AAC5B,WAAO,QAAQ;AAAA,EAChB;AAEA,MAAI,OAAO,UAAU;AACpB,WAAO,QAAQ;AAAA,EAChB;AAEA,MAAI,OAAO,KAAK,MAAM,GAAG;AACxB,WAAO,OAAO,SAAS,MAAM;AAAA,EAC9B;AAEA,MAAI;AACJ,MAAI;AACH,eAAW,MAAM,KAAK,QAAQ,YAAY,OAAO;AAAA,EAClD,SAAS,OAAO;AACf,WAAO,MAAM;AACb,UAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG,KAAmB;AAAA,EAC3D;AAEA,MAAI,SAAS,cAAc,OAAO,SAAS,aAAa,KAAK;AAC5D,WAAO,SAAS;AAAA,EACjB;AAGA,MAAI,SAAS,eAAe,OAAO,SAAS,QAAQ,gBAAgB,GAAG;AACtE,QAAI,CAAC,YAAY;AAChB,YAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG;AAAA,QACtC,SACC;AAAA,QACD,SAAS,SAAS;AAAA,QAClB,MAAM,SAAS;AAAA,MAChB,CAAC;AAAA,IACF;AAEA,UAAM,eAAe,SAAS,QAAQ,gBAAgB;AACtD,UAAM,mBAAe,0BAAW,YAAY,EAAE,OAAO,YAAY;AACjE,QAAI;AACH,YAAM,YAAY,aAAa,KAAK,YAAY,QAAQ;AACxD,aAAO,OAAO;AACd,cAAQ,UAAU;AAAA,QACjB,GAAG,QAAQ;AAAA,QACX,eAAe;AAAA,QACf,kBAAkB;AAAA,MACnB;AAAA,IACD,SAAS,OAAO;AACf,YAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG;AAAA,QACtC,SAAS;AAAA,QACT,GAAI;AAAA,MACL,CAAC;AAAA,IACF;AAEA,QAAI;AACH,iBAAW,MAAM,KAAK,QAAQ,YAAY,OAAO;AACjD,aAAO,SAAS;AAAA,IACjB,SAAS,OAAO;AACf,YAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG;AAAA,QACtC,SAAS;AAAA,MACV,CAAC;AAAA,IACF;AAAA,EACD,OAAO;AACN,UAAM,IAAI,iCAAa,KAAK,QAAQ,GAAG;AAAA,MACtC,GAAI;AAAA,MACJ,SAAS,SAAS;AAAA,IACnB,CAAC;AAAA,EACF;AACD;AAEO,SAAS,eAAe,WAAmB;AACjD,QAAM,SAAsB;AAAA,IAC3B,oBAAoB;AAAA,IACpB,qBAAqB;AAAA,IACrB,eAAe;AAAA,IACf,eAAe;AAAA,EAChB;AACA,SAAO,OAAO,SAAS;AACxB;AA8CO,MAAM,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWtB,MAAM,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;","names":[]}