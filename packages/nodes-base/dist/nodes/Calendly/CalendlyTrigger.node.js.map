{"version":3,"sources":["../../../nodes/Calendly/CalendlyTrigger.node.ts"],"sourcesContent":["import type {\n\tIHookFunctions,\n\tIWebhookFunctions,\n\tIDataObject,\n\tINodeType,\n\tINodeTypeDescription,\n\tIWebhookResponseData,\n} from 'n8n-workflow';\nimport { NodeConnectionTypes } from 'n8n-workflow';\n\nimport { calendlyApiRequest, getAuthenticationType } from './GenericFunctions';\n\nexport class CalendlyTrigger implements INodeType {\n\tdescription: INodeTypeDescription = {\n\t\tdisplayName: 'Calendly Trigger',\n\t\tname: 'calendlyTrigger',\n\t\ticon: 'file:calendly.svg',\n\t\tgroup: ['trigger'],\n\t\tversion: 1,\n\t\tdescription: 'Starts the workflow when Calendly events occur',\n\t\tdefaults: {\n\t\t\tname: 'Calendly Trigger',\n\t\t},\n\t\tinputs: [],\n\t\toutputs: [NodeConnectionTypes.Main],\n\t\tcredentials: [\n\t\t\t{\n\t\t\t\tname: 'calendlyApi',\n\t\t\t\trequired: true,\n\t\t\t\tdisplayOptions: {\n\t\t\t\t\tshow: {\n\t\t\t\t\t\tauthentication: ['apiKey'],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'calendlyOAuth2Api',\n\t\t\t\trequired: true,\n\t\t\t\tdisplayOptions: {\n\t\t\t\t\tshow: {\n\t\t\t\t\t\tauthentication: ['oAuth2'],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t],\n\t\twebhooks: [\n\t\t\t{\n\t\t\t\tname: 'default',\n\t\t\t\thttpMethod: 'POST',\n\t\t\t\tresponseMode: 'onReceived',\n\t\t\t\tpath: 'webhook',\n\t\t\t},\n\t\t],\n\t\tproperties: [\n\t\t\t{\n\t\t\t\tdisplayName: 'Authentication',\n\t\t\t\tname: 'authentication',\n\t\t\t\ttype: 'options',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\t// eslint-disable-next-line n8n-nodes-base/node-param-display-name-miscased\n\t\t\t\t\t\tname: 'OAuth2 (recommended)',\n\t\t\t\t\t\tvalue: 'oAuth2',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'API Key or Personal Access Token',\n\t\t\t\t\t\tvalue: 'apiKey',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: 'apiKey',\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName:\n\t\t\t\t\t'Action required: Calendly will discontinue API Key authentication on May 31, 2025. Update node to use OAuth2 authentication now to ensure your workflows continue to work.',\n\t\t\t\tname: 'deprecationNotice',\n\t\t\t\ttype: 'notice',\n\t\t\t\tdefault: '',\n\t\t\t\tdisplayOptions: {\n\t\t\t\t\tshow: {\n\t\t\t\t\t\tauthentication: ['apiKey'],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Scope',\n\t\t\t\tname: 'scope',\n\t\t\t\ttype: 'options',\n\t\t\t\tdefault: 'user',\n\t\t\t\trequired: true,\n\t\t\t\thint: 'Ignored if you are using an API Key',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Organization',\n\t\t\t\t\t\tvalue: 'organization',\n\t\t\t\t\t\tdescription: 'Triggers the webhook for all subscribed events within the organization',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'User',\n\t\t\t\t\t\tvalue: 'user',\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t'Triggers the webhook for subscribed events that belong to the current user',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Events',\n\t\t\t\tname: 'events',\n\t\t\t\ttype: 'multiOptions',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Event Created',\n\t\t\t\t\t\tvalue: 'invitee.created',\n\t\t\t\t\t\tdescription: 'Receive notifications when a new Calendly event is created',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Event Canceled',\n\t\t\t\t\t\tvalue: 'invitee.canceled',\n\t\t\t\t\t\tdescription: 'Receive notifications when a Calendly event is canceled',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: [],\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t],\n\t};\n\n\twebhookMethods = {\n\t\tdefault: {\n\t\t\tasync checkExists(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookUrl = this.getNodeWebhookUrl('default');\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst events = this.getNodeParameter('events') as string[];\n\n\t\t\t\tconst authenticationType = await getAuthenticationType.call(this);\n\n\t\t\t\t// remove condition once API Keys are deprecated\n\t\t\t\tif (authenticationType === 'apiKey') {\n\t\t\t\t\tconst endpoint = '/hooks';\n\t\t\t\t\tconst { data } = await calendlyApiRequest.call(this, 'GET', endpoint, {});\n\n\t\t\t\t\tfor (const webhook of data) {\n\t\t\t\t\t\tif (webhook.attributes.url === webhookUrl) {\n\t\t\t\t\t\t\tfor (const event of events) {\n\t\t\t\t\t\t\t\tif (!webhook.attributes.events.includes(event)) {\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Set webhook-id to be sure that it can be deleted\n\t\t\t\t\t\twebhookData.webhookId = webhook.id as string;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (authenticationType === 'accessToken') {\n\t\t\t\t\tconst scope = this.getNodeParameter('scope', 0) as string;\n\t\t\t\t\tconst { resource } = await calendlyApiRequest.call(this, 'GET', '/users/me');\n\n\t\t\t\t\tconst qs: IDataObject = {};\n\n\t\t\t\t\tif (scope === 'user') {\n\t\t\t\t\t\tqs.scope = 'user';\n\t\t\t\t\t\tqs.organization = resource.current_organization;\n\t\t\t\t\t\tqs.user = resource.uri;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (scope === 'organization') {\n\t\t\t\t\t\tqs.scope = 'organization';\n\t\t\t\t\t\tqs.organization = resource.current_organization;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst endpoint = '/webhook_subscriptions';\n\t\t\t\t\tconst { collection } = await calendlyApiRequest.call(this, 'GET', endpoint, {}, qs);\n\n\t\t\t\t\tfor (const webhook of collection) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\twebhook.callback_url === webhookUrl &&\n\t\t\t\t\t\t\tevents.length === webhook.events.length &&\n\t\t\t\t\t\t\tevents.every((event: string) => webhook.events.includes(event))\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\twebhookData.webhookURI = webhook.uri;\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tasync create(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst webhookUrl = this.getNodeWebhookUrl('default');\n\t\t\t\tconst events = this.getNodeParameter('events') as string[];\n\n\t\t\t\tconst authenticationType = await getAuthenticationType.call(this);\n\n\t\t\t\t// remove condition once API Keys are deprecated\n\t\t\t\tif (authenticationType === 'apiKey') {\n\t\t\t\t\tconst endpoint = '/hooks';\n\n\t\t\t\t\tconst body = {\n\t\t\t\t\t\turl: webhookUrl,\n\t\t\t\t\t\tevents,\n\t\t\t\t\t};\n\n\t\t\t\t\tconst responseData = await calendlyApiRequest.call(this, 'POST', endpoint, body);\n\n\t\t\t\t\tif (responseData.id === undefined) {\n\t\t\t\t\t\t// Required data is missing so was not successful\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\twebhookData.webhookId = responseData.id as string;\n\t\t\t\t}\n\n\t\t\t\tif (authenticationType === 'accessToken') {\n\t\t\t\t\tconst scope = this.getNodeParameter('scope', 0) as string;\n\t\t\t\t\tconst { resource } = await calendlyApiRequest.call(this, 'GET', '/users/me');\n\n\t\t\t\t\tconst body: IDataObject = {\n\t\t\t\t\t\turl: webhookUrl,\n\t\t\t\t\t\tevents,\n\t\t\t\t\t\torganization: resource.current_organization,\n\t\t\t\t\t\tscope,\n\t\t\t\t\t};\n\n\t\t\t\t\tif (scope === 'user') {\n\t\t\t\t\t\tbody.user = resource.uri;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst endpoint = '/webhook_subscriptions';\n\t\t\t\t\tconst responseData = await calendlyApiRequest.call(this, 'POST', endpoint, body);\n\n\t\t\t\t\tif (responseData?.resource === undefined || responseData?.resource?.uri === undefined) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\twebhookData.webhookURI = responseData.resource.uri;\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tasync delete(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst authenticationType = await getAuthenticationType.call(this);\n\n\t\t\t\t// remove condition once API Keys are deprecated\n\t\t\t\tif (authenticationType === 'apiKey') {\n\t\t\t\t\tif (webhookData.webhookId !== undefined) {\n\t\t\t\t\t\tconst endpoint = `/hooks/${webhookData.webhookId}`;\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait calendlyApiRequest.call(this, 'DELETE', endpoint);\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Remove from the static workflow data so that it is clear\n\t\t\t\t\t\t// that no webhooks are registered anymore\n\t\t\t\t\t\tdelete webhookData.webhookId;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (authenticationType === 'accessToken') {\n\t\t\t\t\tif (webhookData.webhookURI !== undefined) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait calendlyApiRequest.call(\n\t\t\t\t\t\t\t\tthis,\n\t\t\t\t\t\t\t\t'DELETE',\n\t\t\t\t\t\t\t\t'',\n\t\t\t\t\t\t\t\t{},\n\t\t\t\t\t\t\t\t{},\n\t\t\t\t\t\t\t\twebhookData.webhookURI as string,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdelete webhookData.webhookURI;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t},\n\t\t},\n\t};\n\n\tasync webhook(this: IWebhookFunctions): Promise<IWebhookResponseData> {\n\t\tconst bodyData = this.getBodyData();\n\t\treturn {\n\t\t\tworkflowData: [this.helpers.returnJsonArray(bodyData)],\n\t\t};\n\t}\n}\n"],"mappings":"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","names":[]}