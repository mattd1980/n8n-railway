{"version":3,"sources":["../../../nodes/Cal/CalTrigger.node.ts"],"sourcesContent":["import {\n\ttype IDataObject,\n\ttype IHookFunctions,\n\ttype IWebhookFunctions,\n\ttype ILoadOptionsFunctions,\n\ttype INodePropertyOptions,\n\ttype INodeType,\n\ttype INodeTypeDescription,\n\ttype IWebhookResponseData,\n\tNodeConnectionTypes,\n} from 'n8n-workflow';\n\nimport { calApiRequest, sortOptionParameters } from './GenericFunctions';\n\nexport class CalTrigger implements INodeType {\n\tdescription: INodeTypeDescription = {\n\t\tdisplayName: 'Cal.com Trigger',\n\t\tname: 'calTrigger',\n\t\ticon: { light: 'file:cal.svg', dark: 'file:cal.dark.svg' },\n\t\tgroup: ['trigger'],\n\t\tversion: [1, 2],\n\t\tsubtitle: '=Events: {{$parameter[\"events\"].join(\", \")}}',\n\t\tdescription: 'Handle Cal.com events via webhooks',\n\t\tdefaults: {\n\t\t\tname: 'Cal.com Trigger',\n\t\t},\n\t\tinputs: [],\n\t\toutputs: [NodeConnectionTypes.Main],\n\t\tcredentials: [\n\t\t\t{\n\t\t\t\tname: 'calApi',\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t],\n\t\twebhooks: [\n\t\t\t{\n\t\t\t\tname: 'default',\n\t\t\t\thttpMethod: 'POST',\n\t\t\t\tresponseMode: 'onReceived',\n\t\t\t\tpath: 'webhook',\n\t\t\t},\n\t\t],\n\t\tproperties: [\n\t\t\t{\n\t\t\t\tdisplayName: 'Events',\n\t\t\t\tname: 'events',\n\t\t\t\ttype: 'multiOptions',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Booking Cancelled',\n\t\t\t\t\t\tvalue: 'BOOKING_CANCELLED',\n\t\t\t\t\t\tdescription: 'Receive notifications when a Cal event is canceled',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Booking Created',\n\t\t\t\t\t\tvalue: 'BOOKING_CREATED',\n\t\t\t\t\t\tdescription: 'Receive notifications when a new Cal event is created',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Booking Rescheduled',\n\t\t\t\t\t\tvalue: 'BOOKING_RESCHEDULED',\n\t\t\t\t\t\tdescription: 'Receive notifications when a Cal event is rescheduled',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Meeting Ended',\n\t\t\t\t\t\tvalue: 'MEETING_ENDED',\n\t\t\t\t\t\tdescription: 'Receive notifications when a Cal event or meeting has ended',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: [],\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'API Version',\n\t\t\t\tname: 'version',\n\t\t\t\ttype: 'options',\n\t\t\t\tdisplayOptions: {\n\t\t\t\t\tshow: {\n\t\t\t\t\t\t'@version': [1],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tisNodeSetting: true,\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Before v2.0',\n\t\t\t\t\t\tvalue: 1,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'v2.0 Onwards',\n\t\t\t\t\t\tvalue: 2,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: 1,\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'API Version',\n\t\t\t\tname: 'version',\n\t\t\t\ttype: 'options',\n\t\t\t\tdisplayOptions: {\n\t\t\t\t\tshow: {\n\t\t\t\t\t\t'@version': [2],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tisNodeSetting: true,\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Before v2.0',\n\t\t\t\t\t\tvalue: 1,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'v2.0 Onwards',\n\t\t\t\t\t\tvalue: 2,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tdefault: 2,\n\t\t\t},\n\t\t\t{\n\t\t\t\tdisplayName: 'Options',\n\t\t\t\tname: 'options',\n\t\t\t\ttype: 'collection',\n\t\t\t\tplaceholder: 'Add Field',\n\t\t\t\tdefault: {},\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tdisplayName: 'App ID',\n\t\t\t\t\t\tname: 'appId',\n\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\tdescription: 'The ID of the App to monitor',\n\t\t\t\t\t\tdefault: '',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tdisplayName: 'EventType Name or ID',\n\t\t\t\t\t\tname: 'eventTypeId',\n\t\t\t\t\t\ttype: 'options',\n\t\t\t\t\t\ttypeOptions: {\n\t\t\t\t\t\t\tloadOptionsMethod: 'getEventTypes',\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t'The EventType to monitor. Choose from the list, or specify an ID using an <a href=\"https://docs.n8n.io/code/expressions/\">expression</a>.',\n\t\t\t\t\t\tdefault: '',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tdisplayName: 'Payload Template',\n\t\t\t\t\t\tname: 'payloadTemplate',\n\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\tdescription: 'Template to customize the webhook payload',\n\t\t\t\t\t\tdefault: '',\n\t\t\t\t\t\ttypeOptions: {\n\t\t\t\t\t\t\trows: 4,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t],\n\t};\n\n\tmethods = {\n\t\tloadOptions: {\n\t\t\tasync getEventTypes(this: ILoadOptionsFunctions): Promise<INodePropertyOptions[]> {\n\t\t\t\tconst returnData: INodePropertyOptions[] = [];\n\t\t\t\tconst data = await calApiRequest.call(this, 'GET', '/event-types', {});\n\n\t\t\t\tfor (const item of data.event_types) {\n\t\t\t\t\treturnData.push({\n\t\t\t\t\t\tname: item.title,\n\t\t\t\t\t\tvalue: item.id,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn sortOptionParameters(returnData);\n\t\t\t},\n\t\t},\n\t};\n\n\twebhookMethods = {\n\t\tdefault: {\n\t\t\tasync checkExists(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst version = this.getNodeParameter('version', 0) as number;\n\t\t\t\tconst webhookUrl = this.getNodeWebhookUrl('default');\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst events = this.getNodeParameter('events') as string;\n\n\t\t\t\t// Check all the webhooks which exist already if it is identical to the\n\t\t\t\t// one that is supposed to get created.\n\t\t\t\tconst data =\n\t\t\t\t\tversion === 2\n\t\t\t\t\t\t? await calApiRequest.call(this, 'GET', '/webhooks', {})\n\t\t\t\t\t\t: await calApiRequest.call(this, 'GET', '/hooks', {});\n\n\t\t\t\tfor (const webhook of data.webhooks) {\n\t\t\t\t\tif (webhook.subscriberUrl === webhookUrl) {\n\t\t\t\t\t\tfor (const event of events) {\n\t\t\t\t\t\t\tif (!webhook.eventTriggers.includes(event)) {\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Set webhook-id to be sure that it can be deleted\n\t\t\t\t\t\twebhookData.webhookId = webhook.id as string;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tasync create(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst version = this.getNodeParameter('version', 0) as number;\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tconst subscriberUrl = this.getNodeWebhookUrl('default');\n\t\t\t\tconst eventTriggers = this.getNodeParameter('events') as string;\n\t\t\t\tconst options = this.getNodeParameter('options');\n\t\t\t\tconst active = true;\n\n\t\t\t\tconst body = {\n\t\t\t\t\tsubscriberUrl,\n\t\t\t\t\teventTriggers,\n\t\t\t\t\tactive,\n\t\t\t\t\t...(options as object),\n\t\t\t\t};\n\n\t\t\t\tconst responseData =\n\t\t\t\t\tversion === 2\n\t\t\t\t\t\t? await calApiRequest.call(this, 'POST', '/webhooks', body)\n\t\t\t\t\t\t: await calApiRequest.call(this, 'POST', '/hooks', body);\n\n\t\t\t\tif (responseData.webhook.id === undefined) {\n\t\t\t\t\t// Required data is missing so was not successful\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\twebhookData.webhookId = responseData.webhook.id as string;\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tasync delete(this: IHookFunctions): Promise<boolean> {\n\t\t\t\tconst version = this.getNodeParameter('version', 0) as number;\n\t\t\t\tconst webhookData = this.getWorkflowStaticData('node');\n\t\t\t\tif (webhookData.webhookId !== undefined) {\n\t\t\t\t\tconst endpoint =\n\t\t\t\t\t\tversion === 2\n\t\t\t\t\t\t\t? `/webhooks/${webhookData.webhookId}`\n\t\t\t\t\t\t\t: `/hooks/${webhookData.webhookId}`;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait calApiRequest.call(this, 'DELETE', endpoint);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Remove from the static workflow data so that it is clear\n\t\t\t\t\t// that no webhooks are registered anymore\n\t\t\t\t\tdelete webhookData.webhookId;\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t},\n\t\t},\n\t};\n\n\tasync webhook(this: IWebhookFunctions): Promise<IWebhookResponseData> {\n\t\tconst req = this.getRequestObject();\n\t\treturn {\n\t\t\tworkflowData: [\n\t\t\t\tthis.helpers.returnJsonArray({\n\t\t\t\t\ttriggerEvent: req.body.triggerEvent as string,\n\t\t\t\t\tcreatedAt: req.body.createdAt as string,\n\t\t\t\t\t...(req.body.payload as IDataObject),\n\t\t\t\t}),\n\t\t\t],\n\t\t};\n\t}\n}\n"],"mappings":"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","names":[]}