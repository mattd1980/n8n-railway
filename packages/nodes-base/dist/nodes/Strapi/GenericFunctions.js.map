{"version":3,"sources":["../../../nodes/Strapi/GenericFunctions.ts"],"sourcesContent":["import type {\n\tICredentialDataDecryptedObject,\n\tIDataObject,\n\tIExecuteFunctions,\n\tIHookFunctions,\n\tIHttpRequestMethods,\n\tILoadOptionsFunctions,\n\tIRequestOptions,\n\tIWebhookFunctions,\n\tJsonObject,\n} from 'n8n-workflow';\nimport { NodeApiError } from 'n8n-workflow';\n\nexport const removeTrailingSlash = (url: string) => {\n\tif (url.endsWith('/')) {\n\t\treturn url.slice(0, -1);\n\t}\n\treturn url;\n};\n\nexport async function strapiApiRequest(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions | IHookFunctions | IWebhookFunctions,\n\tmethod: IHttpRequestMethods,\n\tresource: string,\n\tbody: IDataObject = {},\n\tqs: IDataObject = {},\n\turi?: string,\n\theaders: IDataObject = {},\n) {\n\tconst authenticationMethod = this.getNodeParameter('authentication', 0);\n\tlet credentials: ICredentialDataDecryptedObject;\n\n\tif (authenticationMethod === 'password') {\n\t\tcredentials = await this.getCredentials('strapiApi');\n\t} else {\n\t\tcredentials = await this.getCredentials('strapiTokenApi');\n\t}\n\n\tconst url = removeTrailingSlash(credentials.url as string);\n\n\ttry {\n\t\tconst options: IRequestOptions = {\n\t\t\theaders: {},\n\t\t\tmethod,\n\t\t\tbody,\n\t\t\tqs,\n\t\t\turi: uri || credentials.apiVersion === 'v4' ? `${url}/api${resource}` : `${url}${resource}`,\n\t\t\tjson: true,\n\t\t\tqsStringifyOptions: {\n\t\t\t\tarrayFormat: 'indices',\n\t\t\t},\n\t\t};\n\t\tif (Object.keys(headers).length !== 0) {\n\t\t\toptions.headers = Object.assign({}, options.headers, headers);\n\t\t}\n\t\tif (Object.keys(body).length === 0) {\n\t\t\tdelete options.body;\n\t\t}\n\n\t\treturn await this.helpers.requestWithAuthentication.call(\n\t\t\tthis,\n\t\t\tauthenticationMethod === 'password' ? 'strapiApi' : 'strapiTokenApi',\n\t\t\toptions,\n\t\t);\n\t} catch (error) {\n\t\tthrow new NodeApiError(this.getNode(), error as JsonObject);\n\t}\n}\n\nexport async function getToken(\n\tthis: IExecuteFunctions | ILoadOptionsFunctions | IHookFunctions | IWebhookFunctions,\n): Promise<{ jwt: string }> {\n\tconst credentials = await this.getCredentials('strapiApi');\n\n\tconst url = removeTrailingSlash(credentials.url as string);\n\n\tlet options = {} as IRequestOptions;\n\toptions = {\n\t\theaders: {\n\t\t\t'content-type': 'application/json',\n\t\t},\n\t\tmethod: 'POST',\n\t\tbody: {\n\t\t\tidentifier: credentials.email,\n\t\t\tpassword: credentials.password,\n\t\t},\n\t\turi: credentials.apiVersion === 'v4' ? `${url}/api/auth/local` : `${url}/auth/local`,\n\t\tjson: true,\n\t};\n\treturn await (this.helpers.request(options) as Promise<{ jwt: string }>);\n}\n\nexport async function strapiApiRequestAllItems(\n\tthis: IHookFunctions | ILoadOptionsFunctions | IExecuteFunctions,\n\tmethod: IHttpRequestMethods,\n\tresource: string,\n\tbody: IDataObject = {},\n\tquery: IDataObject = {},\n\theaders: IDataObject = {},\n\tapiVersion: string = 'v3',\n) {\n\tconst returnData: IDataObject[] = [];\n\n\tlet responseData;\n\tif (apiVersion === 'v4') {\n\t\tquery['pagination[pageSize]'] = 20;\n\t\tquery['pagination[page]'] = 1;\n\t\tdo {\n\t\t\t({ data: responseData } = await strapiApiRequest.call(\n\t\t\t\tthis,\n\t\t\t\tmethod,\n\t\t\t\tresource,\n\t\t\t\tbody,\n\t\t\t\tquery,\n\t\t\t\tundefined,\n\t\t\t\theaders,\n\t\t\t));\n\t\t\tquery['pagination[page]']++;\n\t\t\treturnData.push.apply(returnData, responseData as IDataObject[]);\n\t\t} while (responseData.length !== 0);\n\t} else {\n\t\tquery._limit = 20;\n\t\tquery._start = 0;\n\t\tdo {\n\t\t\tresponseData = await strapiApiRequest.call(\n\t\t\t\tthis,\n\t\t\t\tmethod,\n\t\t\t\tresource,\n\t\t\t\tbody,\n\t\t\t\tquery,\n\t\t\t\tundefined,\n\t\t\t\theaders,\n\t\t\t);\n\t\t\tquery._start += query._limit;\n\t\t\treturnData.push.apply(returnData, responseData as IDataObject[]);\n\t\t} while (responseData.length !== 0);\n\t}\n\treturn returnData;\n}\n\nexport function validateJSON(json: string | undefined): any {\n\tlet result;\n\ttry {\n\t\tresult = JSON.parse(json!);\n\t} catch (exception) {\n\t\tresult = undefined;\n\t}\n\treturn result;\n}\n"],"mappings":"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","names":[]}